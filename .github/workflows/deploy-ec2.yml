name: Deploy to EC2 (Docker Compose)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-ec2-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_SSH_KEY_B64: ${{ secrets.EC2_SSH_KEY_B64 }}
        run: |
          if [ -z "$EC2_HOST" ]; then echo "EC2_HOST secret missing" >&2; exit 1; fi
          if [ -z "$EC2_USER" ]; then echo "EC2_USER secret missing" >&2; exit 1; fi
          if [ -z "$EC2_SSH_KEY" ] && [ -z "$EC2_SSH_KEY_B64" ]; then echo "EC2_SSH_KEY or EC2_SSH_KEY_B64 secret missing" >&2; exit 1; fi
          mkdir -p ~/.ssh
          if [ -n "$EC2_SSH_KEY_B64" ]; then
            echo "$EC2_SSH_KEY_B64" | base64 -d > ~/.ssh/id_rsa
          else
            # Normalize Windows newlines and ensure trailing newline
            printf "%s" "$EC2_SSH_KEY" | sed 's/\r$//' > ~/.ssh/id_rsa
            printf '\n' >> ~/.ssh/id_rsa
          fi
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts

      - name: Deploy on EC2 using Docker
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          ssh -o StrictHostKeyChecking=yes -i ~/.ssh/id_rsa "$EC2_USER"@"$EC2_HOST" <<'SSH'
          set -e

          # Ensure git is installed
          if ! command -v git >/dev/null 2>&1; then
            if command -v apt-get >/dev/null 2>&1; then
              sudo apt-get update -y || true
              sudo apt-get install -y git || true
            elif command -v dnf >/dev/null 2>&1; then
              sudo dnf install -y git || true
            elif command -v yum >/dev/null 2>&1; then
              sudo yum install -y git || true
            fi
          fi

          # Install Docker/Compose if missing
          if ! command -v docker >/dev/null 2>&1; then
            if command -v apt-get >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y docker.io docker-compose-plugin
            elif command -v dnf >/dev/null 2>&1; then
              sudo dnf install -y docker docker-compose-plugin
            elif command -v yum >/dev/null 2>&1; then
              sudo yum install -y docker
            fi
            sudo systemctl enable docker || true
            sudo systemctl start docker || true
            sudo usermod -aG docker "$USER" || true
          fi

          APP_DIR="$HOME/ai-study-planner"
          mkdir -p "$APP_DIR"
          cd "$APP_DIR"

          if [ ! -d ".git" ]; then
            git clone --depth=1 https://github.com/${{ github.repository }} .
          else
            git fetch origin
            git reset --hard origin/main
          fi

          mkdir -p backend
          cat > backend/.env <<ENVV
          GEMINI_API_KEY=${GEMINI_API_KEY}
          ENVV

          # Prefer Docker Compose v2
          if docker compose version >/dev/null 2>&1; then
            sudo docker compose down || true
            sudo docker compose up -d --build
          else
            sudo docker-compose down || true
            sudo docker-compose up -d --build
          fi

          sudo docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}'
          SSH
